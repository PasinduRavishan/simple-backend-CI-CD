name: CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    name: Deploy to GCP
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GCP_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.GCP_VM_IP }} >> ~/.ssh/known_hosts
      
      - name: Deploy to GCP VM
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.GCP_VM_USER }}@${{ secrets.GCP_VM_IP }} << 'EOF'
            set -e
            
            echo "ðŸš€ Starting deployment..."
            
            # Navigate to app directory
            cd ~/apps/simple-backend-CI-CD
            
            # Pull latest changes
            echo "ðŸ“¥ Pulling latest code..."
            git pull origin main
            
            # Install/update dependencies
            echo "ðŸ“¦ Installing dependencies..."
            npm ci --omit=dev
            
            # Update environment variables
            echo "ðŸ”§ Updating environment variables..."
            cat > .env << ENVEOF
          PORT=${{ secrets.PORT }}
          MONGO_URI=${{ secrets.MONGO_URI }}
          NODE_ENV=production
          ENVEOF
            
            # Restart PM2 process
            echo "ðŸ”„ Restarting application..."
            pm2 restart backend-api
            
            # Wait for app to start
            sleep 3
            
            # Check PM2 status
            echo "âœ… Checking application status..."
            pm2 status backend-api
            
            echo "ðŸŽ‰ Deployment completed successfully!"
          EOF
      
      - name: Health Check
        run: |
          echo "ðŸ¥ Running health check..."
          sleep 5
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.GCP_VM_IP }}:${{ secrets.PORT }}/books)
          if [ $RESPONSE -eq 200 ]; then
            echo "âœ… Health check passed! Server is responding."
          else
            echo "âŒ Health check failed! Server returned status code: $RESPONSE"
            exit 1
          fi
      
      - name: Notify Deployment Status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… Deployment successful!"
            echo "ðŸŒ Application URL: http://${{ secrets.GCP_VM_IP }}:${{ secrets.PORT }}/books"
          else
            echo "âŒ Deployment failed!"
          fi
